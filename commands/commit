#!/bin/bash
# Commit all current .git changes and push to remote
# Usage: kk commit [commit-message]
# Example: kk commit "latest changes"
# Example: kk commit (auto-generates message with AI)

DESCRIPTION="Commit all changes and push to remote"
source "$HOME/.kk/lib/common"
kk_trap_errors

generate_commit_message() {
  if [ -z "$XAI_API_KEY" ]; then
    kk_die "Missing XAI_API_KEY in .zshrc"
  fi

  DIFF=$(git diff --cached --stat)
  if [ -z "$DIFF" ]; then
    DIFF=$(git diff --stat)
  fi

  PROMPT="Generate a short, concise git commit message for these changes:\n\n$DIFF"

  curl -s https://api.x.ai/v1/chat/completions \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $XAI_API_KEY" \
    -d "$(jq -n --arg prompt "$PROMPT" '{
      messages: [
        {role: "system", content: "Generate a single-line git commit message. No quotes, no prefix, just the message, be specific where possible."},
        {role: "user", content: $prompt}
      ],
      model: "grok-4-1-fast-non-reasoning",
      stream: false,
      temperature: 0
    }')" | jq -r '.choices[0].message.content'
}

BRANCH=$(git branch --show-current)
FILES=$(git diff --name-only HEAD 2>/dev/null || git diff --name-only)
FILE_COUNT=$(echo "$FILES" | grep -c . || echo "0")

# Stage all changes
git add .

kk_info "committing ${GREEN}${FILE_COUNT}${GRAY} file(s) to ${YELLOW}$BRANCH${NC}"

echo "$FILES" | while read -r file; do
  echo -e "  ${DIM}•${NC} ${CYAN}$(cwd)$file${NC}"
done

# Get commit message
if [ -n "${1:-}" ]; then
  COMMIT_MESSAGE="$1"
else
  kk_info "Generating commit message..."
  COMMIT_MESSAGE=$(generate_commit_message)
fi

echo -e "  ${DIM}•${NC} ${CYAN}\"$COMMIT_MESSAGE\"${NC}${DIM_GRAY}"

# Commit and push
git commit -m "$COMMIT_MESSAGE" || kk_die "Nothing to commit"
git push || kk_die "Push failed"

kk_info "finished ✓"
