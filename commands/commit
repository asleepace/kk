#!/bin/bash
# Commit all current .git changes and push to remote
# Usage: kk commit [commit-message]
# Example: kk commit "latest changes"
# Example: kk commit (auto-generates message with AI)

DESCRIPTION="Commit all changes and push to remote"
source "$HOME/.kk/lib/common"
kk_trap_errors

generate_commit_message() {
  if [ -z "$XAI_API_KEY" ]; then
    kk_die "Missing XAI_API_KEY in .zshrc"
  fi

  DIFF=$(git diff --cached)
  if [ -z "$DIFF" ]; then
    DIFF=$(git diff)
  fi

  # Truncate to ~4000 chars to avoid huge API calls
  DIFF=$(echo "$DIFF" | head -c 4000)
  PROMPT="Generate a short, concise git commit message for these changes:\n\n$DIFF"

  curl -s https://api.x.ai/v1/chat/completions \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $XAI_API_KEY" \
    -d "$(jq -n --arg prompt "$PROMPT" '{
      messages: [
        {role: "system", content: "Generate a single-line git commit message. No lines, Files changed, No quotes, no prefix, just the message, one sentance only. (e.g. update output formatting in commit script.)"},
        {role: "user", content: $prompt}
      ],
      model: "grok-4-1-fast-non-reasoning",
      stream: false,
      temperature: 0.5
    }')" | jq -r '.choices[0].message.content'
}

# Stage all changes
git add .

BRANCH=$(git branch --show-current)
FILES=$(git diff --cached --name-only)

# Count number of file changes
if [ -z "$FILES" ]; then
  FILE_COUNT=0
else
  FILE_COUNT=$(echo "$FILES" | wc -l | tr -d ' ')
fi

# Early exit if no changes
if [ "$FILE_COUNT" -lt 1 ]; then
    echo -e "${YELLOW}No changes to commit!${NC}"
    exit 0
fi



# Get commit message
if [ -n "${1:-}" ]; then
  COMMIT_MESSAGE="$1"
else
  COMMIT_MESSAGE=$(generate_commit_message)
fi

kk_info "${GREEN}committing ${YELLOW}${FILE_COUNT}${GREEN} file(s) to branch ${YELLOW}$BRANCH${GRAY}:\n  ${CYAN}\"${COMMIT_MESSAGE}\"${NC}"

# echo "$FILES" | while read -r file; do
#   echo -e "  ${DIM}•${NC} ${DIM}${GREEN}$file${NC}"
# dones

# Commit and push
# Commit and push
git commit -m "$COMMIT_MESSAGE" 2>&1 | while read -r line; do
  echo -e "  ${DIM}$line${NC}"
done

git push 2>&1 | while read -r line; do
  echo -e "  ${DIM}$line${NC}"
done

kk_info "${GREEN}done ✓${NC}"